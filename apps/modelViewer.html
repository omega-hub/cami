<html lang="en">
<head>
    <title>Model Viewer Test</title>
    <link rel="stylesheet" href="js/jquery.mobile-1.4.5.min.css">
    <script src="js/jquery-1.12.0.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
    <script src="porthole/res/porthole.js"></script>
    <script src="js/hammer.js"></script>
    <script src="https://hammerjs.github.io/dist/hammer.js"></script>
    <script src='js/THREEx.WindowResize.js'></script>
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <!--
    Some Resources for Hammer .js
    http://hammerjs.github.io/api/
    https://www.youtube.com/watch?v=UHSbJmKvGJo
    http://hammerjs.github.io/examples/
    -->

    <style>
    .button{
    background-color: #e8e9f0; 
    border: 1px black;
    color: black;
    text-align: center;
    vertical-align: middle;
    width:235px;
    height: 30px;
    font-size: 15px;
    margin: 4px 2px;
    border-radius: 1px;
    float: center;
    outline:none;
    box-shadow: inset -.5px -1px 5px 0px black;

    
    }

.button:active{
  box-shadow: inset .5px 1px 5px 0px black;
}


    .collapsable{
        outline:none;
    }

    #set3{
        outline:none;
    }
    body { margin: 0; }
    canvas { width: 100%; height: 100% }
    </style> 
</head>

<body style="overflow:hidden;">
    <div data-role="header" id="header">
        <a href="#nav-panel" data-icon="bars" data-iconpos="notext">Menu</a>
        <h1>Model Viewer</h1>
        <script src="js/three.min.js"></script>
        <script src="js/modelViewerPreview.js"></script>
        <button onclick="resetImage()" type="button">Recenter Image</button>
    </div>

    <div data-role="panel" data-position-fixed="true" data-display="push" data-theme="b" id="nav-panel">
        <ul data-role="listview" class="panel">


            <li data-icon="delete"><a href="#" data-rel="close"  >Close menu</a></li>
          
        <div data-role="collapsible-set" class= "innerpanel" id="Allcollapsable">
            <!--REMOVED data-content-theme="c"
                <li data-role="collapsible">
                <h4>Stars Demo</h4>
                <div id="pageButtons">
                </div>
            </li> -->
        </div>

        </ul>
    </div><!-- /panel -->
    
    <script>

        var myElement = document.getElementById('header');

        // create a simple instance
        // by default, it only adds horizontal recognizers
        var mc = new Hammer(myElement);
        // let the pan gesture support all directions.
        // this will block the vertical scrolling on a touch-device while on the element
        mc.get('pan').set({ pointers: 0 });
        mc.get('pinch').set({ enable: true });
        mc.get('pinch').set({ threshold: 0.08 });

        var startMouseX = -1
        var startMouseY = -1
        var dx = 0
        var dy = 0
        delta = 0;
        isZooming = false;
        camX = 0;
        camY = 0;
        camZ = 0;
        camX3JS = 0;
        camY3JS = 0;
        camZ3JS = 0;
        shiftDown = false;
        rotateDist = 0;
        dummyhtml = 0;

        mc.on("panstart", function(ev) {
            ev.preventDefault()
            startMouseX = ev.center.x 
            startMouseY = ev.center.y
            rotateDist = 0;
        });
        // listen to events...
        numTouch = 0
        mc.on("pan", function(ev) {
            ev.preventDefault()
            dx = (ev.center.x - startMouseX)
            dy = (ev.center.y - startMouseY)
            startMouseX = ev.center.x 
            startMouseY = ev.center.y
            numTouch = ev.pointers.length
            {{mc@app: logPan(%dx%, %dy%,0,%numTouch%) }}
            console.log(numTouch)
            if ((numTouch >= 2 && !isZooming && rotateDist <= 0.25) || shiftDown) {
                console.log("panning camera")
                var limit = (5 + (camZ/3))
                var limit3JS = (5 + (camZ))
                var movSpeedX = (dx/(16-(2.0 * camZ)))
                var movSpeedY = (dy/(16-(2.0 * camZ)))
                camX = camX - movSpeedX
                camY = camY + movSpeedY
                //camX = Math.min(Math.max(camX - movSpeedX,-limit),limit)
                //camY = Math.min(Math.max(camY + movSpeedY,-limit),limit)
                {{mc@app: setPan(%camX%, %camY%) }}
                camX3JS = Math.min(Math.max(camX3JS - movSpeedX/12,-limit3JS),limit3JS)
                camY3JS = Math.min(Math.max(camY3JS + movSpeedY/12,-limit3JS),limit3JS)
                setPan3JS(camX,camY)
            } else {
                console.log("rotating camera")
                rotateDist += Math.abs(dx)
                rotateDist += Math.abs(dy)
                {{mc@app: onRotate(%dx%, %dy%,0) }}
                onRotate3JS(dx,dy,0)
            }
            //console.log(ev.type +" gesture detected.");
        });
        /*
        mc.add(new Hammer.Pan(
        event: 'triplepan',
        pointers: 3,
        direction: Hammer.DIRECTION_HORIZONTAL,
        threshold: 0
        ));

        mc.on("triplepan", function(ev) {
            {{mc@app: logPan(%dx%, %dy%,0,%numTouch%) }}
            console.log(ev.type +" triplepanned");
        });
    
        mc.on("tap", function(ev) {
            console.log(ev.type +" gesture detected.");
        });
        */
        mc.on("tap", function(ev) {
            console.log(ev.type +" gesture detected.");
        });

        lastScale = 0
        mc.on("pinchstart", function(ev){
            if (lastScale != 0) {
                delta = ev.scale - lastScale
            }
            lastScale = ev.scale
        });
        mc.on("pinchmove", function(ev){
            ev.preventDefault()
            isZooming = true
            delta = ev.scale - lastScale
            lastScale = ev.scale
            camZ = Math.min(Math.max(camZ - delta,-12),2)
            camZ3JS = Math.min(Math.max(camZ3JS - delta,-4.3),2)
            {{mc@app: setZoom(%camZ%)}}
            setZoom3JS(camZ3JS)
            var limit = (5 + (camZ/3))
            var limit3JS = (5 + (camZ))
            camX = Math.min(Math.max(camX,-limit),limit)
            camY = Math.min(Math.max(camY,-limit),limit)
            {{mc@app: setPan(%camX%, %camY%) }}
            if (camZ > -5.0) {
                camX3JS = Math.min(Math.max(camX3JS,-limit3JS),limit3JS)
                camY3JS = Math.min(Math.max(camY3JS,-limit3JS),limit3JS)
                setPan3JS(camX3JS,camY3JS)
            }
        });
        mc.on("pinchend", function(ev){
            isZooming = false
        });
        porthole.connected = function(event) {
            {{py startApplication(%client_id%, 'modelViewer') }}
            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup", onMouseUp);
            document.addEventListener("mousedown", onMouseDown);
            document.addEventListener("keydown", onKeyDown);
            document.addEventListener("keyup", onKeyUp);       }
        
        //window.blockMenuHeaderScroll = true;
        document.ontouchmove = function(e){ 
            e.preventDefault(); 
        }

        document.addEventListener("mousewheel",onMouseWheel);

        function onMouseWheel(e) {
            console.log("Scrolling the wheel!")
            var e = window.event || e; // old IE support
            delta = Math.max(-0.2, Math.min(0.2, (e.wheelDelta || -e.detail)));

            camZ = Math.min(Math.max(camZ - delta,-12),2)
            camZ3JS = Math.min(Math.max(camZ3JS - (delta/3),-4.3),2)
            {{mc@app: setZoom(%camZ%)}}
            setZoom3JS(camZ3JS)
            var limit = (5 + (camZ/3))
            var limit3JS = (5 + (camZ3JS))
            camX = Math.min(Math.max(camX,-limit),limit)
            camY = Math.min(Math.max(camY,-limit),limit)
            {{mc@app: setPan(%camX%, %camY%) }}
            if (camZ > -5.0) {
                camX3JS = Math.min(Math.max(camX3JS,-limit3JS),limit3JS)
                camY3JS = Math.min(Math.max(camY3JS,-limit3JS),limit3JS)
                setPan3JS(camX3JS,camY3JS)
            }
        }

        function onKeyDown(e) {
            var keycode;
            if (window.event)
                keycode = window.event.keyCode;
            else if (e)
                keycode = e.which;
            console.log(keycode)
            if (keycode == 16) {
                shiftDown = true
                console.log("Shift Down")
            }

        }

        function resetImage()
        {
            camX=0;
            camY=0;
            camZ=0;

            camX3JS=0;
            camY3JS=0;
            camZ3JS=0;
            {{mc@app: setPan(%camX%, %camY%) }}
            setPan3JS(camX,camY)
            {{mc@app: setZoom(%camZ%)}}
            setZoom3JS(camZ3JS)

            resetOrientation3JS()
            {{mc@app: pyresetOrientation(%dummyhtml%)}}

        }

        function onKeyUp(e) {
            var keycode;
            if (window.event)
                keycode = window.event.keyCode;
            else if (e)
                keycode = e.which;
            if (keycode == 16) {
                console.log("shift up")
                shiftDown = false
            }
        }
        var isMouseDown = false
        function onMouseDown(e) {
            dx = 0
            dy = 0
            isMouseDown = true
        }
        function onMouseUp(e) {
            isMouseDown = false
        }
        function onMouseMove(e) {
            if (isMouseDown) {
                dx = (e.clientX - startMouseX)
                dy = (e.clientY - startMouseY)
                //startMouseX = e.clientX
                //startMouseY = e.clientY
                //{{mc@app: onRotate(%dx%, %dy%,0) }}
                //onRotate3JS(dx,dy,0)
            }
        }

        
        modelList=null

        function createModelButtons(ml) {
            // save the argument to the global modelList variable
            // so we can access it from other parts of the interface
            // and we can pass it back to the server app using {{mc@app}}
           modelList=ml;
            //use this $('id of object') to get the object's id and do stuff with it.
            $('nav-panel').hide(300).show(1000).hide(200).show(1000);
            //other events, fadeIn/fadeOut, fadeToggle, slideUp, slideDown
            // you can use the .html operator to rewrite HTML code!!!
            // example $('nav-panel').html('codecodecodecode<tag>')
            // this completely removes the elements inside of the HTML tag and replaces it with your own code.
            // to listen to a button, you use the operator.
            i=0;
            n = ml.length;
            j = 0
            lastFolder = "defaultFolder"
            while (i < n)
            {
                console.log("lastfolder:" + lastFolder)
                console.log("currentFolder:" + ml[i][0])
                if (ml[i][0] != lastFolder){
                    j = j + 1
                    var content = "<div data-role='collapsible' id='set" + j + "'><h4>" + ml[i][0].substring(0,(ml[i][0].length)-1) + "</h4><div id='pageButtons" + j + "'></div></div>";
                    //var content = "fjwiofhwiofhi"
                    $("#Allcollapsable").append( content ).collapsibleset('refresh');;
                    lastFolder = ml[i][0]
                }
                var pageButtons = $('#pageButtons' + j);
                pageButtons.append('<input type="button" class="button" id="button'+i+'" data-path="'+ ml[i][0]+'" value="'+ ml[i][1]+'" onclick="modelButtonClicked(event)"/><img src="' + ml[i][2] +'" class:"leftimage" alt="colorful boxes" style="width:40%"></img>');
                i = i + 1;
            }
            /* some links of helpful guides 
                https://www.youtube.com/watch?v=G-POtu9J-m4&feature=iv&src_vid=hMxGhHNOkCU&annotation_id=annotation_1494025287

                https://www.youtube.com/watch?v=Cc3K2jDdKTo&list=UUVTlvUkGslCV_h-nSAId8Sw&feature=iv&src_vid=G-POtu9J-m4&annotation_id=annotation_4141828117

                http://stackoverflow.com/questions/21192763/how-to-dynamically-add-list-items-in-jquery

                http://stackoverflow.com/questions/20685492/creating-dynamic-list-with-jquery
                */

        }
        //creating a jquery function for always occuring events.
       function modelButtonClicked(event) {

                console.log("Outputting")
                var path = $(event.target).data('path');
                console.log(path);
                event.target.path = path
                console.log(event.target.value)
                console.log(event.target.id)
                {{mc@app: onModelSelect("%event.target.path%" + "%event.target.value%") }}

                //$('#'+panelID).toggle(); //you can concatenate strings with +.
                //use the '#' to gattret the object the id is referring to.
                //var newString = "my new String"
               // $('#'+panelID+ ' .panel-body').html(newString);
               resetImage();
               
            }
        
    </script>
    
    
</body>
</html>